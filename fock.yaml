# FOCK
# Falk's overstaggered corne keyboard
# 
# for use with ergogen
# https://ergogen.cache.works/

# V1.0
# - keys, mcu, trrs
# - name
# - logo
# - completely fucked up routing - no functionality :D
# - no leds
# - no batteries
# - no USB-C :C between boards
#
# V1.1 routing improvements 
# - reordered row & col nets for simpler routing
# - flipped thumb row keys for simpler routing
# - better switch footprint
# - intra-board USB-C
# TODO
# - place vias in the middle between columns and rows as necessary
# - remove silkscreen drawings
# - add vias below usbc for connection
# - wire up columns
# - add my silkscreen logo as ergogen footprint
# - more available reset switch footprint

# V2.0 todo
# - header for trackball
# - flipped battery connector or just flip leads in connector
# - move switch and battery so they are better placed for 

units:
  keysize: 2
  r_mh: 1.55
  fillfix: -0.8
  ctl_x: 34.8+keysize
  ctl_y: 50
  trrs_x: 2*cx
  trrs_y: -0.5*cx
  usbc_x: 2.05*cx
  usbc_y: -0.5*cx
  rst_x: 1.05 * cx
  rst_y: trrs_y
  r_x: trrs_x - 6.5

points:
  zones:
    matrix:
      columns:
        outer:
          spread: cx
          key:
            column_net: P9
            column_mark: PO
        pinky:
          spread: cx
          key:
            column_net: P8
            column_mark: P
        ring:
          spread: cx+2
          stagger: cy-3
          rotate: -10
          key:
            column_net: P7
            column_mark: R
        middle:
          spread: cx
          stagger: cy/2

          key:
            column_net: P6
            column_mark: M
        index:
          spread: cx+0.2
          stagger: -cy/2
          rotate: -9.5
          key:
            column_net: P5
            column_mark: I
        inner:
          spread: cx
          key:
            column_net: P4
            column_mark: IO
        thumb:
          origin: [cx,-0.6*cx]
          rotate: 80
          key:
            rotate: 90
            column_net: P10
            column_mark: T
      rows:
        bottom:
          row_net: P18
          row_mark: B
        home:
          row_net: P19
          row_mark: H
        top:
          row_net: P20
          row_mark: T
        num:
          row_net: P21
          row_mark: N
      key:
        padding: cx
        spread: cy
        bind: cx * 0.6

        footprints: 
          choc:
            type: choc
            params:
              hotswap: true
              reverse: true
              keycaps: true
            nets:
              from: =colrow
              to: =column_net

          # connecting outer pads
          trace1a:
            type: trace
            params:
              points: [[-8.1,3.3],[-5.5,8],[5.5,8]]
          via1:
            type: via
            anchor:
              shift: [5.5,8]
            nets:
              net: =column_net
          trace1b:
            type: trace
            params:
              points: [[5.5,8],[8.1,3.3]]
              side: "B"

          # connecting inner pads
          trace2a:
            type: trace
            params:
              points: [[-3,6],[-1.75,3.75]]
              side: "B"
          via2:
            type: via
            anchor:
              shift: [-1.75,3.75]
            nets:
              net: =colrow
          trace2b:
            type: trace
            params:
              points: [[-1.75,3.75],[1.75,3.75],[3,6],[6.5,6],[7.5,5],[7.5,1.11]]

          diode:
            type: diode
            anchor:
              rotate: 80
              shift: [6.8, -2.8]
            nets:
              from: =colrow
              to: =row_net
outlines:
  exports:
    o_keys:
      main:
        type: keys
        side: left
        size: keysize
    top_plate_capsize:
      main: 
        type: outline
        name: o_keys
      min:
        type: keys
        side: left
        bound: false
        size: cy
        operation: subtract    
    top_plate_keysize:
      main: 
        type: keys
        side: left
        size: 5
      min:
        type: keys
        side: left
        bound: false
        size: 13.8
        operation: subtract
    mounting_holes:
      m_1:
        type: circle
        anchor:
          ref: 
          - matrix_pinky_bottom
          - matrix_thumb_num
          shift: [0, 0]
        radius: r_mh
      m_2:
        type: circle
        anchor:
          ref: 
          - matrix_pinky_num
          - matrix_ring_num
        radius: r_mh
      m_3:
        type: circle
        anchor:
          ref: 
          - matrix_index_num
          - matrix_middle_num
        radius: r_mh
      m_4:
        type: circle
        anchor:
          ref: 
          - matrix_inner_bottom
          - matrix_thumb_bottom
        radius: r_mh
      m_5:
        type: circle
        anchor:
          ref: 
          - matrix_outer_bottom
          - matrix_pinky_home
        radius: r_mh
      m_6:
        type: circle
        anchor:
          ref: 
          - matrix_outer_num
          - matrix_pinky_top
        radius: r_mh
      m_7:
        type: circle
        anchor:
          ref: 
          - matrix_index_num
          - matrix_inner_top
        radius: r_mh
    screw_holes:
      $extends: outlines.exports.mounting_holes
      m_5:
        radius: 1
      m_6:
        radius: 1
      m_7:
        radius: 1
    controller:
      main:
        type: rectangle
        size: [ctl_x,ctl_y]
        anchor:
          ref: matrix_inner_bottom
          shift: [0,-cx]
    cut_filler:
      cf1:
        type: rectangle
        size: [3*cx,1.5*cy]
        anchor:
          ref: matrix_pinky_bottom
          shift: [0,-0.5*cx-keysize+fillfix]
      cf2:
        type: rectangle
        size: [3*cx,2.5*cx+keysize-fillfix]
        anchor:
          ref: matrix_pinky_home
      cfe:
        type: rectangle
        size: [2.5*cx+keysize-fillfix,2*cx]
        anchor:
          ref: matrix_index_home
          rotate: 90
    pcb_shape_pure:
      - +o_keys
      - +controller
      - +cut_filler
    pcb_shape_fillet:
      - type: outline
        name: pcb_shape_pure
        fillet: 3
    pcb_shape:
      - +pcb_shape_fillet
      - -screw_holes
cases:
#  fits the key cap size, not the switches
#  capsize:
#    - name: top_plate_capsize
#      extrude: 2
# fits switches for handwiring
  keysize:
     - name: top_plate_keysize
       extrude: 2
pcbs:
  main:
    outlines:
      edge:
        outline: pcb_shape
        layer: Edge.Cuts
    footprints:
      mcu:
        type: promicro_pretty
        anchor:
          ref: matrix_inner_top
          rotate: -90
          shift: [1.35*cx,-21.5]

      reset_top:
        type: button
        anchor:
          ref: matrix_inner_bottom
          shift: [rst_x,rst_y]
          rotate: 90
        nets:
          from: RST
          to: GND
        params:
          side: F
      reset_bot:
        type: button
        anchor:
          ref: matrix_inner_bottom
          shift: [rst_x,rst_y]
          rotate: 90
        nets:
          from: RST
          to: GND
        params:
          side: B

      usbc_f:
        type: usbc
        anchor:
          ref: 
            - matrix_inner_bottom
          shift: [usbc_x,usbc_y]
          rotate: -90
        nets:
          GND: 'GND'
          SHIELD: 'SHIELD'
          VBUS: 'VBUS'
          VCC: 'RAW'
          CC1: 'CC1'
          CC2: 'CC2'
          DMIN: 'DMIN'
          DPLUS: 'DPLUS'
          P3: 'P3'
          P4: 'P4'

      usbc_b:
        type: usbc
        params:
          side: "B"
        anchor:
          ref: 
            - matrix_inner_bottom
          shift: [usbc_x,usbc_y]
          rotate: -90
        nets:
          GND: 'GND'
          SHIELD: 'SHIELD'
          VBUS: 'VBUS'
          VCC: 'RAW'
          CC1: 'CC1'
          CC2: 'CC2'
          DMIN: 'DMIN'
          DPLUS: 'DPLUS'
          P3: 'P3'
          P4: 'P4'
      # resistor_1:
      #   type: padpair
      #   anchor:
      #     ref: 
      #       - matrix_inner_bottom
      #     shift: [r_x,-6.5]
      #     rotate: 90
      #   nets:
      #     A: P4
      #     B: RAW
      #   params:
      #     width: 1.4
      #     height: 2.5
      #     distance: 1
      #     front: false

      # resistor_2:
      #   type: padpair
      #   anchor:
      #     ref: 
      #       - matrix_inner_bottom
      #     shift: [r_x,-4]
      #     rotate: 90
      #   nets:
      #     A: P3
      #     B: RAW
      #   params:
      #     width: 1.4
      #     height: 2.5
      #     distance: 1
      #     front: false

      # resistor_3:
      #   type: padpair
      #   anchor:
      #     ref: 
      #       - matrix_inner_bottom
      #     shift: [r_x,-11.75]
      #     rotate: 90
      #   nets:
      #     A: P4
      #     B: RAW
      #   params:
      #     width: 1.4
      #     height: 2.5
      #     distance: 1
      #     back: false

      # resistor_4:
      #   type: padpair
      #   anchor:
      #     ref: 
      #       - matrix_inner_bottom
      #     shift: [r_x,-14.25]
      #     rotate: 90
      #   nets:
      #     A: P3
      #     B: RAW
      #   params:
      #     width: 1.4
      #     height: 2.5
      #     distance: 1
      #     back: false

      # vertically connect columns
      t_col_outer:
        type: trace
        anchor:
          ref: matrix_outer_bottom
          shift: [-8.3,3]
        params:
          points: [[0,0],[0,54]]
      t_col_pinky:
        type: trace
        anchor:
          ref: matrix_pinky_bottom
          shift: [-8.3,3]
        params:
          points: [[0,0],[0,54]]
      t_col_ring:
        type: trace
        anchor:
          ref: matrix_ring_bottom
          shift: [-8.3,3]
        params:
          points: [[0,0],[0,54]]
      t_col_middle:
        type: trace
        anchor:
          ref: matrix_middle_bottom
          shift: [-8.3,3]
        params:
          points: [[0,0],[0,54]]
      t_col_index:
        type: trace
        anchor:
          ref: matrix_index_bottom
          shift: [-8.3,3]
        params:
          points: [[0,0],[0,54]]
      t_col_inner:
        type: trace
        anchor:
          ref: matrix_inner_bottom
          shift: [-8.3,3]
        params:
          points: [[0,0],[0,54]]

      #horizontally connect columns
      t_row_num:
        type: trace
        anchor:
          ref: matrix_outer_num
          shift: [6,-6.6]
        params:
          points: [[0,0],[23,0],[30.8,15],[46.3,12.3],[53,20.2],[65.6,17.6],[89.5,3],[106.5,-3]]
          side: "B"
      t_row_top:
        type: trace
        anchor:
          ref: matrix_outer_top
          shift: [6,-6.6]
        params:
          points: [[0,0],[23,0],[28.5,15.3],[42.8,13],[51.1,20.2],[61.9,17.9],[83.7,4],[100.35,-2.35]]
          side: "B"
      t_row_home:
        type: trace
        anchor:
          ref: matrix_outer_home
          shift: [6,-6.6]
        params:
          points: [[0,0],[18,0],[28,15.5],[40.4,12.7],[49.15,20.25],[60,18],[77.7,5.1],[94,-0.7]]
          side: "B"
      t_row_bot:
        type: trace
        anchor:
          ref: matrix_outer_bottom
          shift: [6,-6.6]
        params:
          points: [[0,0],[18,0],[36.5,12.8],[56.14,18.5],[70.6,6.7],[87.3,0.9]]
          side: "B"

# -- CUT in V1.0
# battery and switch
# oled support
# 
# no proper flip side support, aka doesn't mirror footprint
# more parts to route and think about

#      battery_top:
#        type: jstph
#        anchor:
#          ref: 
#            - matrix_inner_home
#            - matrix_inner_top
#          shift: [0.775*cx,5]
#          rotate: 0
#        nets:
#          pos: RAWER
#          neg: GND

#      i2cheader_top:
#        type: oled
#        nets:
#          A: GND
#          B: P14
#          C: P15
#          D: RAWER
#        params:
#          side: F
#        anchor:
#          ref: 
#            - matrix_inner_bottom
#          shift: [1.5*cx,-0.5*cx]
#          rotate: 0

#      powerswitch_B:
#        type: slider
#        anchor:
#          ref: 
#          - matrix_inner_top
#          - matrix_inner_num
#          shift: [0.65*cx,0]
#          rotate: -90
#        nets:
#          from: RAW
#          to: RAWER
#        params:
#          side: B
#      powerswitch_F:
#        type: slider
#        anchor:
#          ref: 
#          - matrix_inner_top
#          - matrix_inner_num
#          shift: [0.65*cx,0]
#          rotate: -90
#        nets:
#          from: RAW
#          to: RAWER
#        params:
#          side: F
