# FOCK
# Falk's overstaggered corne keyboard
# 
# for use with ergogen
# https://ergogen.cache.works/

# V1.0
# - keys, mcu, trrs
# - name
# - logo
# - completely fucked up routing - no functionality :D
# - no leds
# - no batteries
# - no USB-C :C between boards
#
# V1.1 routing improvements 
# - reordered row & col nets for simpler routing
# - flipped thumb row keys for simpler routing
# - better switch footprint
# - intra-board USB-C
# TODO
# - place vias in the middle between columns and rows as necessary
# - remove silkscreen drawings
# - add vias below usbc for connection
# - wire up columns
# - add my silkscreen logo as ergogen footprint
# - more available reset switch footprint

# V2.0 todo
# - header for trackball
# - flipped battery connector or just flip leads in connector
# - move switch and battery so they are better placed for 

units:
  keysize: 2
  r_mh: 1.55
  fillfix: -0.8
  ctl_x: 34.8+keysize
  ctl_y: 50
  trrs_x: 2*cx
  trrs_y: -0.5*cx
  usbc_x: 2.05*cx
  usbc_y: -0.5*cx
  rst_x: 1.05 * cx
  rst_y: trrs_y
  r_x: trrs_x - 6.5

points:
  zones:
    matrix:
      columns:
        outer:
          spread: cx
          key:
            column_net: P9
            column_mark: PO
        pinky:
          spread: cx
          key:
            column_net: P8
            column_mark: P
        ring:
          spread: cx+2
          stagger: cy-3
          rotate: -10
          key:
            column_net: P7
            column_mark: R
        middle:
          spread: cx
          stagger: cy/2

          key:
            column_net: P6
            column_mark: M
        index:
          spread: cx+0.2
          stagger: -cy/2
          rotate: -9.5
          key:
            column_net: P5
            column_mark: I
        inner:
          spread: cx
          key:
            column_net: P4
            column_mark: IO
        thumb:
          origin: [cx,-0.6*cx]
          rotate: 80
          key:
            rotate: 90
            column_net: P10
            column_mark: T
      rows:
        bottom:
          row_net: P18
          row_mark: B
        home:
          row_net: P19
          row_mark: H
        top:
          row_net: P20
          row_mark: T
        num:
          row_net: P21
          row_mark: N
      key:
        padding: cx
        spread: cy
        bind: cx * 0.6

        footprints: 
          choc:
            type: choc
            params:
              hotswap: true
              reverse: true
              keycaps: true
            nets:
              from: =colrow
              to: =column_net

          # connecting outer pads
          trace1a:
            type: trace
            params:
              points: [[-8.1,3.3],[-5.5,8],[5.5,8]]
          via1:
            type: via
            anchor:
              shift: [5.5,8]
            nets:
              net: =column_net
          trace1b:
            type: trace
            params:
              points: [[5.5,8],[8.1,3.3]]
              side: "B"

          # connecting inner pads
          trace2a:
            type: trace
            params:
              points: [[-3,6],[-1.75,3.75]]
              side: "B"
          via2:
            type: via
            anchor:
              shift: [-1.75,3.75]
            nets:
              net: =colrow
          trace2b:
            type: trace
            params:
              points: [[-1.75,3.75],[1.75,3.75],[3,6],[6.5,6],[7.5,5],[7.5,1.11]]

          diode:
            type: diode
            anchor:
              rotate: 80
              shift: [6.8, -2.8]
            nets:
              from: =colrow
              to: =row_net
    # get anchor for connector
    connector:
      anchor:
        ref: 
          - matrix_inner_bottom
        shift: [usbc_x,usbc_y]
      columns:
        usbcc:
      rows:
        usbcr:
      key:
        footprints:
          usbc_f:
            type: usbc
            anchor:
              ref: 
                - matrix_inner_bottom
              shift: [usbc_x,usbc_y]
              rotate: -90
            nets:
              GND: 'GND'
              SHIELD: 'SHIELD'
              VBUS: 'VBUS'
              VCC: 'RAW'
              CC1: 'CC1'
              CC2: 'CC2'
              DMIN: 'DMIN'
              DPLUS: 'DPLUS'
              P3: 'P3'
              P4: 'P4'
          usbc_b:
            type: usbc
            params:
              side: "B"
            anchor:
              ref: 
                - matrix_inner_bottom
              shift: [usbc_x,usbc_y]
              rotate: -90
            nets:
              GND: 'GND'
              SHIELD: 'SHIELD'
              VBUS: 'VBUS'
              VCC: 'RAW'
              CC1: 'CC1'
              CC2: 'CC2'
              DMIN: 'DMIN'
              DPLUS: 'DPLUS'
              P3: 'P3'
              P4: 'P4'

          # flippable DMIN
          via_dmin:
            type: via
            anchor:
              shift: [-6,0]
            nets:
              net: 'DMIN'
            params:
              d: 0.2
          trace_dmin_f:
            type: trace
            params:
              points: [[-7,0.25],[-6.25,0.25],[-6,0],[-6,-0.5],[-6.25,-0.75],[-7,-0.75]]
          trace_dmin_b:
            type: trace
            params:
              points: [[-7,-0.25],[-6.25,-0.25],[-6,0],[-6,0.5],[-6.25,0.75],[-7,0.75]]
              side: "B"

          # flippable DPLUS
          via_dplus:
            type: via
            anchor:
              shift: [-5,0]
            nets:
              net: 'DPLUS'
            params:
              d: 0.2
          trace_dplus_f:
            type: trace
            params:
              points: [[-5,0],[-5,0.5],[-5.25,0.75],[-7,0.75],[-8,0.75],[-8.25,0.5],[-8.25,0],[-8,-0.25],[-7,-0.25]]
          # connecting inner pads
          trace_dplus_b:
            type: trace
            params:
              points: [[-5,0],[-5,-0.5],[-5.25,-0.75],[-7,-0.75],[-8,-0.75],[-8.25,-0.5],[-8.25,0],[-8,0.25],[-7,0.25]]
              side: "B"

          # flippable CC2
          via_cc2:
            type: via
            anchor:
              shift: [-4,0]
            nets:
              net: 'CC2'
            params:
              d: 0.2
          trace_cc2_f:
            type: trace
            params:
              points: [[-7,-1.25],[-4.5,-1.25],[-4,-0.75],[-4,0]]
          trace_cc2_b:
            type: trace
            params:
              points: [[-7,1.25],[-4.5,1.25],[-4,0.75],[-4,0]]
              side: "B"

          # flippable SBU1
          via_sbu1:
            type: via
            anchor:
              shift: [-3,0]
            nets:
              net: 'SBU1'
            params:
              d: 0.2
          trace_sbu1_f:
            type: trace
            params:
              points: [[-7,1.25],[-3.5,1.25],[-3,0.75],[-3,0]]
          trace_sbu1_b:
            type: trace
            params:
              points: [[-7,-1.25],[-3.5,-1.25],[-3,-0.75],[-3,0]]
              side: "B"

          # flippable sbu2
          via_sbu2:
            type: via
            anchor:
              shift: [-2,0]
            nets:
              net: 'SBU2'
            params:
              d: 0.2
          trace_sbu2_f:
            type: trace
            params:
              points: [[-7,-1.75],[-2.75,-1.75],[-2,-1],[-2,0]]
          trace_sbu2_b:
            type: trace
            params:
              points: [[-7,1.75],[-2.75,1.75],[-2,1],[-2,0]]
              side: "B"

          # flippable cc1
          via_cc1:
            type: via
            anchor:
              shift: [-1,0]
            nets:
              net: 'CC1'
            params:
              d: 0.2
          trace_cc1_f:
            type: trace
            params:
              points: [[-7,1.75],[-1.75,1.75],[-1,1],[-1,0]]
          trace_cc1_b:
            type: trace
            params:
              points: [[-7,-1.75],[-1.75,-1.75],[-1,-1],[-1,0]]
              side: "B"

          # flippable vbus
          via_vbus_1:
            type: via
            anchor:
              shift: [-6,2.5]
            nets:
              net: 'VBUS'
            params:
              d: 0.2
          via_vbus_2:
            type: via
            anchor:
              shift: [-6,-2.5]
            nets:
              net: 'VBUS'
            params:
              d: 0.2
          trace_vbus_f:
            type: trace
            params:
              points: [[-7,2.5],[-1.75,2.5],[-0.5,1],[-0.5,-1],[-1.75,-2.5],[-7,-2.5]]
          trace_vbus_b1:
            type: trace
            params:
              points: [[-7,2.5],[-6,2.5]]
              side: "B"
          trace_vbus_b2:
            type: trace
            params:
              points: [[-7,-2.5],[-6,-2.5]]
              side: "B"

          # flippable GND
          via_gnd_1:
            type: via
            anchor:
              shift: [-5,3.25]
            nets:
              net: 'GND'
            params:
              d: 0.2
          via_gnd_2:
            type: via
            anchor:
              shift: [-5,-3.25]
            nets:
              net: 'GND'
            params:
              d: 0.2
          trace_gnd_f1:
            type: trace
            params:
              points: [[-7,3.25],[-5,3.25]]
          trace_gnd_f2:
            type: trace
            params:
              points: [[-7,-3.25],[-5,-3.25]]
          trace_gnd_b:
            type: trace
            params:
              points: [[-7,3.25],[-1.75,3.25],[-0.5,2],[-0.5,-2],[-1.75,-3.25],[-7,-3.25]]
              side: "B"

outlines:
  exports:
    o_keys:
      main:
        type: keys
        side: left
        size: keysize
    top_plate_capsize:
      main: 
        type: outline
        name: o_keys
      min:
        type: keys
        side: left
        bound: false
        size: cy
        operation: subtract    
    top_plate_keysize:
      main: 
        type: keys
        side: left
        size: 5
      min:
        type: keys
        side: left
        bound: false
        size: 13.8
        operation: subtract
    mounting_holes:
      m_1:
        type: circle
        anchor:
          ref: 
          - matrix_pinky_bottom
          - matrix_thumb_num
          shift: [0, 0]
        radius: r_mh
      m_2:
        type: circle
        anchor:
          ref: 
          - matrix_pinky_num
          - matrix_ring_num
        radius: r_mh
      m_3:
        type: circle
        anchor:
          ref: 
          - matrix_index_num
          - matrix_middle_num
        radius: r_mh
      m_4:
        type: circle
        anchor:
          ref: 
          - matrix_inner_bottom
          - matrix_thumb_bottom
        radius: r_mh
      m_5:
        type: circle
        anchor:
          ref: 
          - matrix_outer_bottom
          - matrix_pinky_home
        radius: r_mh
      m_6:
        type: circle
        anchor:
          ref: 
          - matrix_outer_num
          - matrix_pinky_top
        radius: r_mh
      m_7:
        type: circle
        anchor:
          ref: 
          - matrix_index_num
          - matrix_inner_top
        radius: r_mh
    screw_holes:
      $extends: outlines.exports.mounting_holes
      m_5:
        radius: 1
      m_6:
        radius: 1
      m_7:
        radius: 1
    controller:
      main:
        type: rectangle
        size: [ctl_x,ctl_y]
        anchor:
          ref: matrix_inner_bottom
          shift: [0,-cx]
    cut_filler:
      cf1:
        type: rectangle
        size: [3*cx,1.5*cy]
        anchor:
          ref: matrix_pinky_bottom
          shift: [0,-0.5*cx-keysize+fillfix]
      cf2:
        type: rectangle
        size: [3*cx,2.5*cx+keysize-fillfix]
        anchor:
          ref: matrix_pinky_home
      cfe:
        type: rectangle
        size: [2.5*cx+keysize-fillfix,2*cx]
        anchor:
          ref: matrix_index_home
          rotate: 90
    pcb_shape_pure:
      - +o_keys
      - +controller
      - +cut_filler
    pcb_shape_fillet:
      - type: outline
        name: pcb_shape_pure
        fillet: 3
    pcb_shape:
      - +pcb_shape_fillet
      - -screw_holes
cases:
#  fits the key cap size, not the switches
#  capsize:
#    - name: top_plate_capsize
#      extrude: 2
# fits switches for handwiring
  keysize:
     - name: top_plate_keysize
       extrude: 2
pcbs:
  main:
    outlines:
      edge:
        outline: pcb_shape
        layer: Edge.Cuts
    footprints:
      mcu:
        type: promicro_pretty
        anchor:
          ref: matrix_inner_top
          rotate: -90
          shift: [1.35*cx,-21.5]

      reset_top:
        type: button
        anchor:
          ref: matrix_inner_bottom
          shift: [rst_x,rst_y]
          rotate: 90
        nets:
          from: RST
          to: GND
        params:
          side: F
      reset_bot:
        type: button
        anchor:
          ref: matrix_inner_bottom
          shift: [rst_x,rst_y]
          rotate: 90
        nets:
          from: RST
          to: GND
        params:
          side: B

      # resistor_1:
      #   type: padpair
      #   anchor:
      #     ref: 
      #       - matrix_inner_bottom
      #     shift: [r_x,-6.5]
      #     rotate: 90
      #   nets:
      #     a: P4
      #     b: RAW
      #   params:
      #     width: 1.4
      #     height: 2.5
      #     distance: 1
      #     front: false

      # resistor_2:
      #   type: padpair
      #   anchor:
      #     ref: 
      #       - matrix_inner_bottom
      #     shift: [r_x,-4]
      #     rotate: 90
      #   nets:
      #     a: P3
      #     b: RAW
      #   params:
      #     width: 1.4
      #     height: 2.5
      #     distance: 1
      #     front: false

      # resistor_3:
      #   type: padpair
      #   anchor:
      #     ref: 
      #       - matrix_inner_bottom
      #     shift: [r_x,-11.75]
      #     rotate: 90
      #   nets:
      #     a: P4
      #     b: RAW
      #   params:
      #     width: 1.4
      #     height: 2.5
      #     distance: 1
      #     back: false

      # resistor_4:
      #   type: padpair
      #   anchor:
      #     ref: 
      #       - matrix_inner_bottom
      #     shift: [r_x,-14.25]
      #     rotate: 90
      #   nets:
      #     a: P3
      #     b: RAW
      #   params:
      #     width: 1.4
      #     height: 2.5
      #     distance: 1
      #     back: false

      # vertically connect columns
      t_col_outer:
        type: trace
        anchor:
          ref: matrix_outer_bottom
          shift: [-8.3,3]
        params:
          points: [[0,0],[0,54]]
      t_col_pinky:
        type: trace
        anchor:
          ref: matrix_pinky_bottom
          shift: [-8.3,3]
        params:
          points: [[0,0],[0,54]]
      t_col_ring:
        type: trace
        anchor:
          ref: matrix_ring_bottom
          shift: [-8.3,3]
        params:
          points: [[0,0],[0,54]]
      t_col_middle:
        type: trace
        anchor:
          ref: matrix_middle_bottom
          shift: [-8.3,3]
        params:
          points: [[0,0],[0,54]]
      t_col_index:
        type: trace
        anchor:
          ref: matrix_index_bottom
          shift: [-8.3,3]
        params:
          points: [[0,0],[0,54]]
      t_col_inner:
        type: trace
        anchor:
          ref: matrix_inner_bottom
          shift: [-8.3,3]
        params:
          points: [[0,0],[0,54]]
      t_col_thumb:
        type: trace
        anchor:
          ref: matrix_thumb_bottom
          shift: [5.5,8]
        params:
          points: [[0,0],[54,0]]

      #horizontally connect columns
      #num
      t_row_num_pinky:
        type: trace
        anchor:
          ref: matrix_outer_num
          shift: [6,-6.6]
        params:
          points: [[43,-58],[-2,-58],[-4,-56],[-4,-2],[-2,0],[22,0]]
          side: "B"
      t_row_num_ring:
        type: trace
        anchor:
          ref: matrix_ring_num
          shift: [-10,-6.6]
        params:
          points: [[0,-8.5],[0,-2],[2,0],[18,0],[20,2]]
          side: "B"
      t_row_num_middle:
        type: trace
        anchor:
          ref: matrix_middle_num
          shift: [-7,-6.6]
        params:
          points: [[-1,-2],[1,0],[17,0]]
          side: "B"
      t_row_num_index:
        type: trace
        anchor:
          ref: matrix_index_num
          shift: [-10,-6.6]
        params:
          points: [[0,0],[37,0],[38.5,-1.5],[38.5,-17.5]]
          side: "B"

      #top
      t_row_top_pinky:
        type: trace
        anchor:
          ref: matrix_outer_top
          shift: [6,-6.6]
        params:
          points: [[33.5,-39.5],[-1.75,-39.5],[-3.5,-37.75],[-3.5,-2],[-1.5,0],[22,0]]
          side: "B"
      t_row_top_ring:
        type: trace
        anchor:
          ref: matrix_ring_top
          shift: [-10,-6.6]
        params:
          points: [[0,-12],[0,-2],[2,0],[18,0],[20,2]]
          side: "B"
      t_row_top_middle:
        type: trace
        anchor:
          ref: matrix_middle_top
          shift: [-7,-6.6]
        params:
          points: [[-1,-2],[1,0],[17,0]]
          side: "B"
      t_row_top_index:
        type: trace
        anchor:
          ref: matrix_index_top
          shift: [-10,-6.6]
        params:
          points: [[0,0],[37,0],[38.5,-1.5],[38.5,-14.5]]
          side: "B"

      #home
      t_row_home_pinky:
        type: trace
        anchor:
          ref: matrix_outer_home
          shift: [6,-6.6]
        params:
          points: [[33.25,-21],[-1.5,-21],[-3,-19.5],[-3,-2],[-1,0],[20,0]]
          side: "B"
      t_row_home_ring:
        type: trace
        anchor:
          ref: matrix_ring_home
          shift: [-10,-6.6]
        params:
          points: [[0,-14.25],[0,-2],[2,0],[18,0],[20,2]]
          side: "B"
      t_row_home_middle:
        type: trace
        anchor:
          ref: matrix_middle_home
          shift: [-7,-6.6]
        params:
          points: [[-1,-2],[1,0],[17,0]]
          side: "B"
      t_row_home_index:
        type: trace
        anchor:
          ref: matrix_index_home
          shift: [-10,-6.6]
        params:
          points: [[2,0],[37,0],[38.5,1.5]]
          side: "B"

      #bottom
      t_row_bottom_pinky:
        type: trace
        anchor:
          ref: matrix_outer_bottom
          shift: [6,-6.6]
        params:
          points: [[0,0],[21,0]]
          side: "B"
      t_row_bottom_ring:
        type: trace
        anchor:
          ref: matrix_ring_bottom
          shift: [-10,-6.6]
        params:
          points: [[5,-13],[5,-2],[7,0],[18,0],[20,2]]
          side: "B"
      t_row_bottom_middle:
        type: trace
        anchor:
          ref: matrix_middle_bottom
          shift: [-7,-6.6]
        params:
          points: [[-1,-2],[1,0],[15,0]]
          side: "B"
      t_row_bottom_index:
        type: trace
        anchor:
          ref: matrix_index_bottom
          shift: [-10,-6.6]
        params:
          points: [[7,0],[37,0],[38.5,1.5],[38.5,14.5]]
          side: "B"

      # connections from thumb row
      t_row_bottom_thumb:
        type: trace
        anchor:
          ref: matrix_thumb_bottom
          shift: [6,-6.6]
        params:
          points: [[0,0],[8,0],[10,-2],[10,-8]]
          side: "B"
      t_row_home_thumb:
        type: trace
        anchor:
          ref: matrix_thumb_home
          shift: [6,-6.6]
        params:
          points: [[0,0],[2.5,-2.5],[39,-2.5],[41.5,0],[41.5,16]]
          side: "B"
      t_row_top_thumb:
        type: trace
        anchor:
          ref: matrix_thumb_top
          shift: [6,-6.6]
        params:
          points: [[0,0],[2,-2],[21,-2],[23,0],[23,16]]
          side: "B"
      t_row_num_thumb:
        type: trace
        anchor:
          ref: matrix_thumb_num
          shift: [6,-6.6]
        params:
          points: [[0,0],[-3,3],[-3,14]]
          side: "B"



# -- cut in v1.0
# battery and switch
# oled support
# 
# no proper flip side support, aka doesn't mirror footprint
# more parts to route and think about

#      battery_top:
#        type: jstph
#        anchor:
#          ref: 
#            - matrix_inner_home
#            - matrix_inner_top
#          shift: [0.775*cx,5]
#          rotate: 0
#        nets:
#          pos: RAWER
#          neg: GND

#      i2cheader_top:
#        type: oled
#        nets:
#          a: GND
#          b: P14
#          c: P15
#          d: RAWER
#        params:
#          side: f
#        anchor:
#          ref: 
#            - matrix_inner_bottom
#          shift: [1.5*cx,-0.5*cx]
#          rotate: 0

#      powerswitch_b:
#        type: slider
#        anchor:
#          ref: 
#          - matrix_inner_top
#          - matrix_inner_num
#          shift: [0.65*cx,0]
#          rotate: -90
#        nets:
#          from: RAW
#          to: RAWER
#        params:
#          side: b
#      powerswitch_f:
#        type: slider
#        anchor:
#          ref: 
#          - matrix_inner_top
#          - matrix_inner_num
#          shift: [0.65*cx,0]
#          rotate: -90
#        nets:
#          from: RAW
#          to: RAWER
#        params:
#          side: f
